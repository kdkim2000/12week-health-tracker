# .github/workflows/deploy.yml
# GitHub Pages ë°°í¬ ì›Œí¬í”Œë¡œìš° (ê°œì„  ë²„ì „)

name: Deploy to GitHub Pages

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  # main ë¸Œëœì¹˜ì— pushí•  ë•Œ ì‹¤í–‰
  push:
    branches: ["main"]
    # ë¶ˆí•„ìš”í•œ ë¹Œë“œ ë°©ì§€ (ì„ íƒì‚¬í•­)
    paths-ignore:
      - '**.md'
      - '.gitignore'
  
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:

# ê¶Œí•œ ì„¤ì •
permissions:
  contents: read        # ì €ì¥ì†Œ ì½ê¸°
  pages: write         # GitHub Pages ì“°ê¸°
  id-token: write      # OIDC í† í° ë°œê¸‰

# ë™ì‹œ ì‹¤í–‰ ì œì–´ (ê°™ì€ ê·¸ë£¹ì˜ ì›Œí¬í”Œë¡œìš°ëŠ” í•˜ë‚˜ë§Œ ì‹¤í–‰)
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==================== ë¹Œë“œ ì‘ì—… ====================
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. Node.js í™˜ê²½ ì„¤ì •
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
      
      # 3. ìºì‹œ ë³µì› (ë¹Œë“œ ì†ë„ í–¥ìƒ) - ì„ íƒì‚¬í•­
      - name: ğŸ“¦ Restore cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
      
      # 4. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“š Install dependencies
        run: npm ci
      
      # 5. TypeScript íƒ€ì… ì²´í¬ (ì„ íƒì‚¬í•­)
      - name: ğŸ” Type check
        run: npx tsc --noEmit
        continue-on-error: true
      
      # 6. ESLint ì‹¤í–‰ (ê²½ê³ ë§Œ, ë¹Œë“œ ì¤‘ë‹¨ ì•ˆ í•¨)
      - name: ğŸ” Run ESLint
        run: npm run lint || true
      
      # 7. Next.js ë¹Œë“œ
      - name: ğŸ—ï¸ Build Next.js
        run: npm run build
        env:
          NODE_ENV: production
          # ì¶”ê°€ í™˜ê²½ ë³€ìˆ˜ (í•„ìš”ì‹œ)
          # NEXT_PUBLIC_GA_ID: ${{ secrets.GA_ID }}
      
      # 8. .nojekyll íŒŒì¼ ìƒì„± (GitHub Pagesì—ì„œ _next í´ë” ì ‘ê·¼ í—ˆìš©)
      - name: ğŸ“„ Create .nojekyll
        run: touch ./out/.nojekyll
      
      # 9. ë¹Œë“œ ê²°ê³¼ë¬¼ ê²€ì¦ (ì„ íƒì‚¬í•­)
      - name: âœ… Verify build output
        run: |
          echo "ğŸ“Š Build output size:"
          du -sh ./out
          echo "ğŸ“ Files in output:"
          ls -la ./out
      
      # 10. GitHub Pagesìš© ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./out

  # ==================== ë°°í¬ ì‘ì—… ====================
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      # ë°°í¬ ì™„ë£Œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: ğŸ‰ Deployment complete
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"